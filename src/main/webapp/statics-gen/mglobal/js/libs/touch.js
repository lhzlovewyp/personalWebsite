define(function(){function g(a,n,l){var d;if(!l){d=function(){return true}}else{d=function(i,j){return i.hasOwnProperty(j)}}if(a!=null&&n!=null){var c,b,m;for(m in a){if(a.hasOwnProperty(m)){b=a[m];if(n===b){continue}if(b!==undefined&&d(n,m)){n[m]=b}}}return n}}function h(a){var b=function(){};b.prototype=a;return new b()}function f(a){var c={element:false,start:false,dbclick:false,click:false,move:false,hover:false,end:false,sliceEnd:false,startZoom:false,zoom:false,gesture:false,prevent:false,userSelect:false,stopPropagation:true};var b=h(e);g(a,c,true);g(c,b);b.init();return b}var e={init:function(){if(!this.element){return false}this.errorRange=10;this.holdon=1000;this.clickRecord=[];this.offset=this.getOffset(this.element);if(this.userSelect){this.element.style.mozUserSelect="none";this.element.style.webkitUserSelect="none";
this.element.onselectstart=function(){return false}}var a=!!("ontouchstart" in window);if(a){this.bindtouchEvents()}else{this.bindclickEvents()}},bindtouchEvents:function(){var b=this;var a=this.element;a.addEventListener("touchstart",function(l){if(l.target.nodeName==="INPUT"){return}b.startEv=b.startEv||{};b.offset=b.getOffset(b.element);b.startEv.time=b.getTime();b.startEv.points=[];for(var c=0;c<l.targetTouches.length;c++){var n={};n.x=l.targetTouches[c].pageX;n.y=l.targetTouches[c].pageY;b.startEv.points.push(n)}if(b.startEv.points.length===1){var m=b.startEv.points[0];var d={x:m.x-b.offset.left,y:m.y-b.offset.top};b.start&&b.start.apply(b.element,[l,d.x,d.y])}else{if(b.startEv.points.length===2){b.startZoom&&b.startZoom.apply(null)}}if(b.stopPropagation){l.stopPropagation();l.preventDefault()
}},false);a.addEventListener("touchmove",function(y){if(!b.startEv){return false}if(b.stopPropagation){y.stopPropagation()}if(b.startEv.points.length>1){if(b.stopPropagation){y.preventDefault()}if(b.startEv.points.length===2){var C=b.offset.left;var w=b.offset.top;var G={x:b.startEv.points[0].x-C,y:b.startEv.points[0].y-w};var c={x:b.startEv.points[1].x-C,y:b.startEv.points[1].y-w};var x={x:y.targetTouches[0].pageX-C,y:y.targetTouches[0].pageY-w};var z={x:y.targetTouches[1].pageX-C,y:y.targetTouches[1].pageY-w};b.zoom&&b.zoom.apply(null,[y,G,c,x,z])}return false}else{b.moveEv=b.moveEv||{};b.moveLists=b.moveLists||[];var t={};t.x=y.targetTouches[0].pageX;t.y=y.targetTouches[0].pageY;if(!b.moveEv.angle){var E=b.startEv.points[0];var B=b.getAngle(E.x,t.x,E.y,t.y);if(!!b.prevent&&b.stopPropagation){switch(b.prevent){case"x":if(Math.abs(B)<20||Math.abs(B)>160){y.preventDefault()
}break;case"y":if(Math.abs(B)>70&&Math.abs(B)<110){y.preventDefault()}break;case"all":y.preventDefault();break}}if((B>-45)&&(B<=45)){b.moveEv.dir="lr"}if((B>135)||(B<=-135)){b.moveEv.dir="rl"}if((B>45)&&(B<=135)){b.moveEv.dir="ud"}if((B>-135)&&(B<=-45)){b.moveEv.dir="du"}b.moveEv.angle=B}var F=b.getTime();if(b.moveEv.last){var D=Math.sqrt(Math.pow(Math.abs(t.x-b.moveEv.last.x),2)+Math.pow(Math.abs(t.y-b.moveEv.last.y),2));b.speed=D/(F-b.moveEv.last.time);b.moveEv.last.time=F;b.moveEv.last.x=t.x;b.moveEv.last.y=t.y}else{b.moveEv.last={};b.moveEv.last.time=F;b.moveEv.last.x=t.x;b.moveEv.last.y=t.y}var H=t.x-b.startEv.points[0].x;var d=t.y-b.startEv.points[0].y;var A={x:t.x-b.offset.left,y:t.y-b.offset.top};b.move&&b.move.apply(a,[y,b.moveEv.dir,H,d,A.x,A.y]);b.moveLists.push({t:F,x:t.x,y:t.y})
}},false);a.addEventListener("touchend",function(t){b.end&&b.end.apply(b.element,[]);if(!b.startEv){return false}if(b.stopPropagation){t.stopPropagation()}var o=b.startEv.points[0];var p=b.getTime();if(!b.moveEv||Math.abs(b.moveEv.last.x-o.x)<b.errorRange&&Math.abs(b.moveEv.last.y-o.y)<b.errorRange){if(p-b.startEv.time<b.holdon){b.click&&b.click.apply(b.element,[t,o.x-b.offset.left,o.y-b.offset.top]);if(b.clickRecord.length>=1){var c=b.clickRecord[b.clickRecord.length-1];if(p-c.time<500&&Math.abs(o.x-c.x)<b.errorRange&&Math.abs(o.y-c.y)<b.errorRange){b.dbclick&&b.dbclick.apply(b.element,[t,o.x-b.offset.left,o.y-b.offset.top]);b.clickRecord=[]}}b.clickRecord.push({time:p,x:o.x,y:o.y})}}else{var d=b.moveLists.length;if(d>2){var r=b.moveLists[d-1];var s=b.moveLists[d-2];var q={};q.x=(r.x-s.x)/(r.t-s.t);
q.y=(r.y-s.y)/(r.t-s.t);b.sliceEnd&&b.sliceEnd.apply(b.element,[q])}else{}}b.startEv=null;b.moveEv=null;b.moveLists=[];if(b.stopPropagation){t.stopPropagation();t.preventDefault()}},false)},bindclickEvents:function(){var c=this,b=this.element,a=document;this.addHandler(b,"mousedown",function(k){if(k.button!==0){return false}c.startEv=c.startEv||{};c.offset=c.getOffset(c.element);c.startEv.time=c.getTime();c.startEv.points=[];var l={};if(k.pageX||k.pageY){l.x=k.pageX;l.y=k.pageY}else{l.x=k.clientX+a.body.scrollLeft+a.documentElement.scrollLeft;l.y=k.clientY+a.body.scrollTop+a.documentElement.scrollTop}c.startEv.points.push(l);var d={x:l.x-c.offset.left,y:l.y-c.offset.top};c.start&&c.start.apply(c.element,[k,d.x,d.y])},false);this.addHandler(b,"mousemove",function(d){if(!c.startEv){return false
}c.moveEv=c.moveEv||{};c.moveLists=c.moveLists||[];var t={};if(d.pageX||d.pageY){t.x=d.pageX;t.y=d.pageY}else{t.x=d.clientX+a.body.scrollLeft+a.documentElement.scrollLeft;t.y=d.clientY+a.body.scrollTop+a.documentElement.scrollTop}if(!c.moveEv.angle){var p=c.startEv.points[0];var v=c.getAngle(p.x,t.x,p.y,t.y);if((v>-45)&&(v<=45)){c.moveEv.dir="lr"}if((v>135)||(v<=-135)){c.moveEv.dir="rl"}if((v>45)&&(v<=135)){c.moveEv.dir="ud"}if((v>-135)&&(v<=-45)){c.moveEv.dir="du"}c.moveEv.angle=v}var q=c.getTime();c.moveEv.last=c.moveEv.last||{};c.moveEv.last.time=q;c.moveEv.last.x=t.x;c.moveEv.last.y=t.y;var r=t.x-c.startEv.points[0].x;var s=t.y-c.startEv.points[0].y;var u={x:t.x-c.offset.left,y:t.y-c.offset.top};c.move&&c.move.apply(b,[d,c.moveEv.dir,r,s,u.x,u.y]);c.moveLists.push({t:q,x:t.x,y:t.y})});this.addHandler(b,"mouseup",function(u){c.end&&c.end.apply(c.element,[]);
if(!c.startEv){return false}var p=c.startEv.points[0];var q=c.getTime();if(!c.moveEv||Math.abs(c.moveEv.last.x-p.x)<c.errorRange&&Math.abs(c.moveEv.last.y-p.y)<c.errorRange){if(q-c.startEv.time<c.holdon){c.click&&c.click.apply(c.element,[u,p.x-c.offset.left,p.y-c.offset.top]);if(c.clickRecord.length>=1){var v=c.clickRecord[c.clickRecord.length-1];if(q-v.time<500&&Math.abs(p.x-v.x)<c.errorRange&&Math.abs(p.y-v.y)<c.errorRange){c.dbclick&&c.dbclick.apply(c.element,[p.x-c.offset.left,p.y-c.offset.top]);c.clickRecord=[]}}c.clickRecord.push({time:q,x:p.x,y:p.y})}}else{var d=c.moveLists.length;if(d>2){var s=c.moveLists[d-1];var t=c.moveLists[d-2];var r={};r.x=(s.x-t.x)/(s.t-t.t);r.y=(s.y-t.y)/(s.t-t.t);c.sliceEnd&&c.sliceEnd.apply(c.element,[r])}else{}}c.startEv=null;c.moveEv=null;c.moveLists=[]});
this.addHandler(b,"mouseout",function(d){if(c.checkHover(d,this)){c.startEv=null;c.moveEv=null;c.moveLists=[]}})},checkHover:function(a,b){if(a.type=="mouseover"){return !this.contains(b,a.relatedTarget||a.fromElement)&&!((a.relatedTarget||a.fromElement)===b)}else{return !this.contains(b,a.relatedTarget||a.toElement)&&!((a.relatedTarget||a.toElement)===b)}},contains:function(b,a){return b.contains?b!=a&&b.contains(a):!!(b.compareDocumentPosition(a)&16)},addHandler:function(a,b,c){if(a.addEventListener){a.addEventListener(b,c,false)}else{if(a.attachEvent){a.attachEvent("on"+b,c)}}},getTime:function(){return new Date().getTime()},getAngle:function(l,m,c,d){this.pi=this.pi||Math.PI;var n=m-l;var a=d-c;var b=Math.atan2(a,n)*180/this.pi;return b},getOffset:function(a){var c=a.offsetTop;var d=a.offsetLeft;
if(a.offsetParent!=null){var b=this.getOffset(a.offsetParent);c+=b.top;d+=b.left}return{top:c,left:d}}};return f});