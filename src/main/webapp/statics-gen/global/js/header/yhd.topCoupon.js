(function(b){b(function(){var N=window.loli||(window.loli={});var B=N.app=N.app||{};var I=N.app.coupon=N.app.coupon||{};var D=N.yhdStore;var A=b.cookie("provinceId");var J=b.cookie("yihaodian_uid");var y="top_prism_coupon";var H="top_prism_coupon_num_"+J;var F=(typeof globalTopPrismFlag!="undefined"&&globalTopPrismFlag=="0")?0:1;var L=b("#hdPrismWrap");var a=b("#hdPrismCoupon");var x=b("#hdPrismCouponNum");var E=b("#hdPrismCouponList");if(!J||!A||!F){return}var z=function(){if(D){var c=D.isIE();if(c==0||c>=9||(c==8&&D.isRoot())){D.getFromRoot(H,function(d){if(d&&d.status==1){var e=(d.value&&!isNaN(d.value))?parseInt(d.value):0;a.data("couponsNumData",e);if(e>0){x.text(e<=99?e:99);x.show()}else{if(isNaN(d.value)||d.value==null){w()}}}else{w()}})}else{w()}}};var w=function(){var d=URLPrefix.central+"/homepage/ajaxFindNewPrismCouponsNum.do?callback=?";
var e=function(f){a.data("couponsNumData",f);a.data("couponsNumLoaded",1);if(f>0){x.text(f<=99?f:99);x.show()}else{x.text("");x.hide()}if(D){D.setFromRoot(H,f)}};var c={userId:J,currSiteId:(typeof currSiteId=="undefined")?1:currSiteId,currSiteType:1,provinceId:A};b.getJSON(d,c,function(h){var f=h;if(f){if(f.status==1){var g=f.nums;e(g)}}})};var M=function(){var e=URLPrefix.central+"/homepage/ajaxFindNewPrismCoupons.do?callback=?";var c=a.data("couponsNumData");var f=function(h){a.data("couponsData",h);var g=v(h);E.removeClass("global_loading").html(g);E.height("auto")};var d={userId:J,total:c!=null?c:50,currSiteId:(typeof currSiteId=="undefined")?1:currSiteId,currSiteType:1,provinceId:A};b.getJSON(e,d,function(h){var i=h;if(i){if(i.status==1){var g=i.coupons;f(g)}}})};var v=function(d){var f="http://coupon.yhd.com/myCoupon";
var l=[];if(d&&d.length>0){var h=false;var i=false;for(var c=0;c<d.length;c++){var e=d[c];if(e.timeType==1){if(!h){l.push("<p class='hd_prism_tit'>即将到期</p>");h=true}}if(e.timeType!=1){if(!i){if(h){l.push("<p class='hd_prism_tit'>其他抵用券</p>");i=true}else{l.push("<p class='hd_prism_tit'>我的抵用券</p>");i=true}}}var j=e.timeType==1?(e.endDateTimeStr+" 结束"):(e.startDateTimeStr+" 开始");var m="http://list.yhd.com/redirectCoupon/"+e.couponActiveDefId;var k=y+"_"+e.couponNumber;var g=e.timeType==1?"hd_coupon_org":(e.timeType==2?"":"hd_coupon_gray");if(e.couponUserType==0||e.couponUserType==5||e.couponUserType==6||e.couponUserType==7||e.couponUserType==8){m=f}if(e.timeType==1){if(e.dateDiff==0){j="<b>今天</b>到期"}else{j="还剩 <b>"+e.dateDiff+"</b>天 到期"}}else{if(e.timeType==2){j=e.startDateStr+" 至 "+e.endDateStr
}else{if(e.timeType==3){j=e.startDateTimeStr+" 开始"}}}l.push("<a href='"+m+"' data-ref='"+k+"' target='_blank' title='"+e.couponInfo+"' class='hd_coupon "+g+"'>");l.push("<div class='clearfix'>");l.push("<b class='hd_coupon_price'>&yen;<em>"+e.amount+"</em></b>");l.push("<span class='hd_coupon_sort'>"+e.couponInfo+"</span>");l.push("</div>");l.push("<p class='hd_coupon_timer'>"+j+"</p>");l.push("</a>")}l.push("<a class='hd_more_btn' href='"+f+"' target='_blank' data-ref='"+y+"_more'>查看更多</a>")}else{l.push("<div class='hd_none_tips'>");l.push("<span class='hd_none_icon'></span>");l.push("<p class='hd_none_text'>您还没有礼券哦~</p>");l.push("</div>")}return l.join("")};var K=function(){var c=b("a.hd_prism_tab",a);c.attr("href","javascript:void(0);");c.removeAttr("target");c.click(function(){if(a.data("dataLoaded")=="1"&&a.hasClass("hd_cur")){G(a);
return}if(!a.data("couponsNumLoaded")){w()}var d=function(e){if(e.result==1){if(a.data("dataLoaded")=="1"){C(a)}else{a.data("dataLoaded","1");E.height("100");C(a);M();if(c.data("clicked")!=1){gotracker("2",y);c.data("clicked",1)}}}else{if(yhdPublicLogin){yhdPublicLogin.showLoginDiv()}}};N.globalCheckLogin(d)});b(document.body).click(function(f){var d=b(this);var e=f.target?f.target:f.srcElement;if(e){var g=b(e).parents("div.hd_prism_wrap").size();if(g==0&&a.hasClass("hd_cur")){a.removeClass("hd_cur")}}})};var C=function(c){L.find("div.hd_prism,div.hd_mini_cart").removeClass("hd_cur");c.addClass("hd_cur")};var G=function(c){c.removeClass("hd_cur")};I.showNum=function(){z();K()};window.topCouponTimeoutHandler=setTimeout(function(){if(a.size()>0){I.showNum()}},3*1000)})})(jQuery);