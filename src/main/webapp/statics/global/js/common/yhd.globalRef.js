var YHDREF=YHDREF||{};(function($){var refParseFunc=null;YHDREF.defineGlobalRefParse=function(getRefAttrFunc){refParseFunc=getRefAttrFunc};$(function(){var head="gl.",prevTk="[",afterTk="]";var util=loli.util.url;var getPrevPageFlag=function(){var _location=location;var href=_location.href;var params=util.getParams(href);if(!params||!params.ref){return 0}var ref=params.ref;if(checkRef(ref)){return ref.substring(ref.lastIndexOf(".")+1)}return 0};var checkRef=function(ref){if(ref.indexOf(head)!=0||ref.indexOf(prevTk)<=0||ref.indexOf(afterTk)<=0){return false}var reg=/gl\.\d\.\d\.\w+\.\[[\S]+\]\.[\S]+\.[\S]+$/;var result=reg.exec(ref);return result?true:false};var prevPageFlag=getPrevPageFlag();var currentPageFlag=loli.global.uid;var checkDataRef=function(dataRef){return(typeof(dataRef)!="undefined"&&(dataRef instanceof Array)&&dataRef.length>=1)
};function isLinkRef(link){if(typeof(link)=="undefined"||!link||link=="#"||link.indexOf("#")==0||link=="###"||link.toLowerCase().indexOf("javascript")>=0){return false}return true}function addPosition(posObj,link){var uniId=loli.global.uid;if(uniId&&uniId.indexOf("-")>0){var pageVer=uniId.split("-")[0];if(pageVer&&posObj!=null){var tps="x"+posObj.xrate+"y"+posObj.yrate;var tiInfo="x:"+posObj.xrate+";y:"+posObj.yrate;var pageTag=loli.util.generateMixed(4);var ti=pageTag;var key=pageVer+"_"+ti;var cookie_ti=$.cookie(key);var times=1;while(cookie_ti){ti=pageTag+"_"+times;key=pageVer+"_"+ti;cookie_ti=$.cookie(key);times++}var writeFlag=false;try{var expiresDate=new Date();expiresDate.setTime(expiresDate.getTime()+(5*60*1000));$.cookie(key,tiInfo,{expires:expiresDate,path:"/",domain:no3wUrl});var new_cookie_ti=$.cookie(key);
if(new_cookie_ti==tiInfo){writeFlag=true}}catch(ex){}var params={ti:ti,tps:""};if(!writeFlag){params={ti:"",tps:tps}}link=util.appendParams(link,params)}}return link}var eventType="mousedown";if(loli.isMobile()){eventType="click"}$("body").delegate("a, area",eventType,function(e){var _this=$(this);var isTrkCustom=jQuery.trim(_this.attr("isTrkCustom"));if(typeof(isTrkCustom)!="undefined"&&isTrkCustom&&isTrkCustom=="1"){return}var dataRef=_this.data("data-tracker2cookie");if(!dataRef){var data_ref=_this.attr("data-ref");if(data_ref&&data_ref.indexOf("[")==0&&data_ref.indexOf("]")==data_ref.length-1){eval("dataRef = "+data_ref)}else{if(data_ref){data_ref="['"+data_ref+"']";eval("dataRef = "+data_ref)}}}if(!dataRef&&refParseFunc){dataRef=refParseFunc(_this);if(checkDataRef(dataRef)){_this.data("data-tracker2cookie",dataRef)
}}var link=jQuery.trim(_this.attr("href"));var spmData=loli.spm.getData(_this);var posObj=null;if(loli.getMousePos){posObj=loli.getMousePos(e);if(posObj!=null){spmData=spmData||{};spmData.eventXRate=posObj.xrate;spmData.eventYRate=posObj.yrate}}if(isLinkRef(link)){if(checkDataRef(dataRef)){addTrackPositionToCookie.apply(window,[1].concat(dataRef))}else{if(jQuery.trim(dataRef)!=""){addTrackPositionToCookie(1,dataRef)}}var _rewrite=_this.data("data-globalRewrite");if(_rewrite&&_rewrite==1){if(spmData&&spmData.tp&&spmData.pageTypeId){var rewriteLink=addPosition(posObj,link);if(rewriteLink!=link){_this.attr("href",rewriteLink)}}return}if(spmData){var tc=spmData.tc;var tp=spmData.tp;var tce=spmData.tce;var abtest=spmData.abtestValue;var params={tc:tc,tp:tp,tce:tce,abtest:abtest};link=util.appendParams(link,params);
if(spmData.tp&&spmData.pageTypeId){link=addPosition(posObj,link)}}_this.attr("href",link);_this.data("data-globalRewrite",1);var trackerCode=_this.attr("data-event");if(trackerCode&&trackerCode=="add_cart"){var pmid=_this.attr("data-pmid")||2;var proid=_this.attr("data-proid");spmData.positionTypeId="4";gotracker(pmid,trackerCode,proid,spmData)}else{if(trackerCode){gotracker(2,trackerCode,null,spmData)}}}else{var isTrkCustom=jQuery.trim(_this.attr("isTrkCustom"));if(typeof(isTrkCustom)!="undefined"&&isTrkCustom&&isTrkCustom=="1"){return}else{if(checkDataRef(dataRef)){var pmId=dataRef[2]?dataRef[2]:2;var tk=dataRef[0];var productId=dataRef[1]?dataRef[1]:null;gotracker(pmId,tk,productId,spmData)}else{var trackerCode=_this.attr("data-event");if(trackerCode&&trackerCode=="add_cart"){var pmid=_this.attr("data-pmid")||2;
var proid=_this.attr("data-proid");spmData.positionTypeId="4";gotracker(pmid,trackerCode,proid,spmData)}else{if(trackerCode){gotracker(2,trackerCode,null,spmData)}else{if(spmData){gotracker(2,"buttonPosition",null,spmData)}}}}}}})})})(jQuery);