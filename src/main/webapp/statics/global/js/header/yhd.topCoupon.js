(function(a){a(function(){var b=window.loli||(window.loli={});var n=b.app=b.app||{};var g=b.app.coupon=b.app.coupon||{};var l=b.yhdStore;var o=a.cookie("provinceId");var f=a.cookie("yihaodian_uid");var q="top_prism_coupon";var h="top_prism_coupon_num_"+f;var j=(typeof globalTopPrismFlag!="undefined"&&globalTopPrismFlag=="0")?0:1;var d=a("#hdPrismWrap");var u=a("#hdPrismCoupon");var r=a("#hdPrismCouponNum");var k=a("#hdPrismCouponList");if(!f||!o||!j){return}var p=function(){if(l){var v=l.isIE();if(v==0||v>=9||(v==8&&l.isRoot())){l.getFromRoot(h,function(x){if(x&&x.status==1){var w=(x.value&&!isNaN(x.value))?parseInt(x.value):0;u.data("couponsNumData",w);if(w>0){r.text(w<=99?w:99);r.show()}else{if(isNaN(x.value)||x.value==null){s()}}}else{s()}})}else{s()}}};var s=function(){var w=URLPrefix.central+"/homepage/ajaxFindNewPrismCouponsNum.do?callback=?";
var v=function(y){u.data("couponsNumData",y);u.data("couponsNumLoaded",1);if(y>0){r.text(y<=99?y:99);r.show()}else{r.text("");r.hide()}if(l){l.setFromRoot(h,y)}};var x={userId:f,currSiteId:(typeof currSiteId=="undefined")?1:currSiteId,currSiteType:1,provinceId:o};a.getJSON(w,x,function(y){var A=y;if(A){if(A.status==1){var z=A.nums;v(z)}}})};var c=function(){var v=URLPrefix.central+"/homepage/ajaxFindNewPrismCoupons.do?callback=?";var x=u.data("couponsNumData");var y=function(z){u.data("couponsData",z);var A=t(z);k.removeClass("global_loading").html(A);k.height("auto")};var w={userId:f,total:x!=null?x:50,currSiteId:(typeof currSiteId=="undefined")?1:currSiteId,currSiteType:1,provinceId:o};a.getJSON(v,w,function(z){var B=z;if(B){if(B.status==1){var A=B.coupons;y(A)}}})};var t=function(C){var A="http://coupon.yhd.com/myCoupon";
var F=[];if(C&&C.length>0){var y=false;var x=false;for(var D=0;D<C.length;D++){var B=C[D];if(B.timeType==1){if(!y){F.push("<p class='hd_prism_tit'>即将到期</p>");y=true}}if(B.timeType!=1){if(!x){if(y){F.push("<p class='hd_prism_tit'>其他抵用券</p>");x=true}else{F.push("<p class='hd_prism_tit'>我的抵用券</p>");x=true}}}var w=B.timeType==1?(B.endDateTimeStr+" 结束"):(B.startDateTimeStr+" 开始");var E="http://list.yhd.com/redirectCoupon/"+B.couponActiveDefId;var v=q+"_"+B.couponNumber;var z=B.timeType==1?"hd_coupon_org":(B.timeType==2?"":"hd_coupon_gray");if(B.couponUserType==0||B.couponUserType==5||B.couponUserType==6||B.couponUserType==7||B.couponUserType==8){E=A}if(B.timeType==1){if(B.dateDiff==0){w="<b>今天</b>到期"}else{w="还剩 <b>"+B.dateDiff+"</b>天 到期"}}else{if(B.timeType==2){w=B.startDateStr+" 至 "+B.endDateStr
}else{if(B.timeType==3){w=B.startDateTimeStr+" 开始"}}}F.push("<a href='"+E+"' data-ref='"+v+"' target='_blank' title='"+B.couponInfo+"' class='hd_coupon "+z+"'>");F.push("<div class='clearfix'>");F.push("<b class='hd_coupon_price'>&yen;<em>"+B.amount+"</em></b>");F.push("<span class='hd_coupon_sort'>"+B.couponInfo+"</span>");F.push("</div>");F.push("<p class='hd_coupon_timer'>"+w+"</p>");F.push("</a>")}F.push("<a class='hd_more_btn' href='"+A+"' target='_blank' data-ref='"+q+"_more'>查看更多</a>")}else{F.push("<div class='hd_none_tips'>");F.push("<span class='hd_none_icon'></span>");F.push("<p class='hd_none_text'>您还没有礼券哦~</p>");F.push("</div>")}return F.join("")};var e=function(){var v=a("a.hd_prism_tab",u);v.attr("href","javascript:void(0);");v.removeAttr("target");v.click(function(){if(u.data("dataLoaded")=="1"&&u.hasClass("hd_cur")){i(u);
return}if(!u.data("couponsNumLoaded")){s()}var w=function(x){if(x.result==1){if(u.data("dataLoaded")=="1"){m(u)}else{u.data("dataLoaded","1");k.height("100");m(u);c();if(v.data("clicked")!=1){gotracker("2",q);v.data("clicked",1)}}}else{if(yhdPublicLogin){yhdPublicLogin.showLoginDiv()}}};b.globalCheckLogin(w)});a(document.body).click(function(z){var x=a(this);var w=z.target?z.target:z.srcElement;if(w){var y=a(w).parents("div.hd_prism_wrap").size();if(y==0&&u.hasClass("hd_cur")){u.removeClass("hd_cur")}}})};var m=function(v){d.find("div.hd_prism,div.hd_mini_cart").removeClass("hd_cur");v.addClass("hd_cur")};var i=function(v){v.removeClass("hd_cur")};g.showNum=function(){p();e()};window.topCouponTimeoutHandler=setTimeout(function(){if(u.size()>0){g.showNum()}},3*1000)})})(jQuery);