(function(b){b(function(){var R=window.loli||(window.loli={});var B=R.app=R.app||{};var N=R.app.msg=R.app.msg||{};var x=b.cookie("provinceId");var O=b.cookie("yihaodian_uid");var H=(typeof H=="undefined")?1:H;var J=1;var a=b("#hdUserMsg");var y=a.size()>0?a.attr("data-cfg"):0;if(!O||!x||!y){return}var F=function(e){var f=new Date();f.setTime(e);var d=f.getMonth()+1;var c=f.getDate();return d+"月"+c+"日"};var A=function(c){if(c!=null&&c!=""){c=c.replace(/\&/g,"&amp;");c=c.replace(/\</g,"&lt;");c=c.replace(/\>/g,"&gt;");c=c.replace(/\\/g,"&#92;");c=c.replace(/\'/g,"&#039;");c=c.replace(/\"/g,"&#034;")}return c};var Q=function(d){var c=URLPrefix.central+"/homepage/ajaxFindUserMsgsNum.do?callback=?";var e={userId:O,currSiteId:H,currSiteType:J,provinceId:x};b.getJSON(c,e,function(f){if(f&&f.status==1){d(f.value)
}else{d(0)}})};var M=function(d){var f="http://webim.yhd.com/customer/offline.action";var e=function(h){var g=0;if(!isNaN(h)){g=parseInt(h)}if(g>0){d(g)}else{d(0)}};var c={userId:O,currSiteId:H,currSiteType:J,provinceId:x};b.ajax({url:f,data:c,dataType:"jsonp",jsonp:"jsonpCallback",success:function(g){if(g){e(g)}else{e(0)}}})};var E=function(d){var c=URLPrefix.central+"/homepage/ajaxFindUserMsgs.do?callback=?";var e={userId:O,currSiteId:H,currSiteType:J,provinceId:x};b.getJSON(c,e,function(f){if(f&&f.status==1){d(f.value)}else{d(null)}})};var z=function(d,f){var e=URLPrefix.central+"/homepage/ajaxUpdateUserMsgsStatus.do?callback=?";var c={userId:O,msgIds:d.join(","),currSiteId:H,currSiteType:J,provinceId:x};b.getJSON(e,c,function(g){if(g&&g.status==1){f(g.value)}else{f(null)}})};var I=function(d,j){var h="http://edm.yhd.com/pcMsg/myMessage.action";
var f="http://webim.yhd.com/global/frontCheckPoint.action";var c=[];if(d==0&&(!j||j.length==0)){c.push("<div class='hd_none_notice'>");c.push("<span class='hd_none_pic'></span>");c.push("<p>无新消息</p>");c.push("</div>");return c.join("")}if(j&&j.length>0){c.push("<p class='hd_ntc_top clearfix' data-tpc='1'>");c.push("<a class='fl' href='javascript:;'>全部标记为已读</a>");c.push("<a class='blue_link fr' href='"+h+"' target='_blank'>查看更多</a>");c.push("</p>")}c.push("<div class='hd_notice_detail'>");if(d>0){c.push("<div class='hd_service clearfix' data-tpc='2'>");c.push("<span class='fl'><i></i>客服消息</span>");c.push("<a class='fr hd_delete_notc' href='javascript:;'>×</a>");c.push("<a class='fr hd_notc_num' href='"+f+"' target='_blank'><u>"+d+"</u>条新消息</a>");c.push("</div>")}if(j&&j.length>0){c.push("<div class='hd_notice_list' data-tpc='3'>");
for(var i=0;i<j.length;i++){var e=j[i];var g=e.link?e.link:"javascript:;";c.push("<dl data-msgId='"+e.msgId+"'>");c.push("<dt class='clearfix'>");c.push("<b class='fl'>"+e.title+"</b>");c.push("<a class='fr hd_delete_notc' href='javascript:;'>×</a>");c.push("<em class='fr'>"+F(e.createTime)+"</em>");c.push("</dt>");c.push("<dd>");c.push("<a class='hd_notice_txt' href='"+g+"'"+(e.link?" target='_blank'>":">")+A(e.content)+"</a>");c.push("</dd>");c.push("</dl>")}c.push("</div>")}c.push("</div>");return c.join("")};var L=function(){var e=a.data("customerMsgsNum")!=null?a.data("customerMsgsNum"):0;var c=a.data("userMsgsNum")!=null?a.data("userMsgsNum"):0;var d=e+c;if(d>0){a.find("a.hd_notice_tit").html("<i></i>新消息(<span>"+(d>=100?"99+":d)+"</span>)");a.addClass("hd_has_notice")}else{a.find("a.hd_notice_tit").html("<i></i>新消息(<span>0</span>)");
a.removeClass("hd_has_notice")}};var C=function(){var d=0;var c=0;var g=null;var f=function(h){c=h;a.data("userMsgsNum",c);a.show();L();D()};var e=function(h){if(g){clearTimeout(g)}d=h;a.data("customerMsgsNum",d);Q(f)};M(e);g=setTimeout(function(){a.data("customerMsgsNum",0);Q(f)},1500)};var P=function(){var e=a.data("customerMsgsNum")!=null?a.data("customerMsgsNum"):0;var c=a.data("userMsgsNum")!=null?a.data("userMsgsNum"):0;var d=function(g){if(g&&g.length>0){c=g.length}else{c=0}a.data("userMsgsNum",c);L();var f=I(e,g);a.find("div.hd_notice").html(f);a.addClass("hd_notice_hover")};E(d)};var G=function(){var d=[];var c=a.find("div.hd_notice_list dl");c.each(function(){d.push(b(this).attr("data-msgId"))});z(d,function(e){if(e){var f=I(0,null);a.find("div.hd_notice").html(f);a.data("userMsgsNum",0);
a.data("customerMsgsNum",0);a.find("a.hd_notice_tit").html("<i></i>新消息(<span>0</span>)");a.removeClass("hd_has_notice")}})};var K=function(d){var c=[];c.push(d);var e=a.find("div.hd_notice_list dl[data-msgId='"+d+"']");z(c,function(f){if(f){P()}})};var D=function(){var d,c;a.mouseenter(function(){if(c){clearTimeout(c)}d=setTimeout(function(){if(a.data("loaded")){a.addClass("hd_notice_hover");return}a.data("loaded",1);P()},200)});a.mouseleave(function(){if(d){clearTimeout(d)}c=setTimeout(function(){a.removeClass("hd_notice_hover")},200)});a.delegate("p.hd_ntc_top a.fl","click",function(){G()});a.delegate("div.hd_notice_list a.hd_delete_notc","click",function(){var e=b(this).parents("dl").attr("data-msgId");K(e)});a.delegate("div.hd_service a.hd_delete_notc","click",function(){a.data("customerMsgsNum",0);
P()});a.delegate(".hd_notice_list dl","mouseenter",function(){b(this).addClass("hd_notc_cur")});a.delegate(".hd_notice_list dl","mouseleave",function(){b(this).removeClass("hd_notc_cur")});a.delegate(".hd_notice_detail","mousewheel",function(f,h){var e=b(".hd_notice_detail",a).scrollTop();var g=b(".hd_notice_detail",a).outerHeight();var i=(b(".hd_service",a).outerHeight()?b(".hd_service",a).outerHeight():0)+b(".hd_notice_list",a).outerHeight()-1;if(g>i){f.preventDefault()}if(e==i-g&&(h<0)){f.preventDefault()}})};N.showMsgsNum=function(){if(a.size()>0){R.globalCheckLogin(function(c){if(c&&c.result==1){C()}})}};N.showMsgs=function(){if(a.size()>0){R.globalCheckLogin(function(c){if(c&&c.result==1){P()}})}};window.topMsgTimeoutHandler=setTimeout(function(){N.showMsgsNum()},1*1000)})})(jQuery);